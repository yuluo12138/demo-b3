{% extends "base.html" %}

{% block title %}数据展示系统 - 实时搜索{% endblock %}
{% block page_title %}数据接收概览与搜索{% endblock %}
{% block nav_links %}
    <!-- 主页不需要返回首页链接 -->
{% endblock %}

{% block content %}
    <div class="search-controls">
        <div>
            <label for="searchQuery">内容搜索</label>
            <input type="text" id="searchQuery" placeholder="输入 ID、定位时间、经纬度、自定义数据等...">
        </div>
        <div>
            <label>接收时间范围</label>
            <div class="input-group">
                <input type="date" id="startDate">
                <input type="date" id="endDate">
            </div>
        </div>
    </div>

    <div class="summary-stats">
        <div class="summary-item">
            <div class="value" id="displayedIdCount">0</div>
            <div class="label">显示卡号数量</div>
        </div>
        <div class="summary-item">
            <div class="value" id="displayedMessageCount">0</div>
            <div class="label">显示消息总数</div>
        </div>
    </div>

    <div id="jsError" class="no-data-message error" style="display: none;">
        前端脚本发生错误，请查看浏览器控制台 (F12) 获取详情。
    </div>
    <div id="noSearchResults" class="no-data-message" style="display: none;">
        未找到匹配的数据。请尝试调整搜索条件。
    </div>
    <div id="initialNoData" class="no-data-message" style="display: block;">
        目前没有接收到任何数据。等待设备上报数据或刷新页面。
    </div>

    <div id="messagesContainer">
        <!-- 消息卡片将在这里通过 JavaScript 渲染 -->
    </div>

    <script>
        // 调试步骤 1: 确认 JavaScript 文件加载并开始执行
        console.log('--- Frontend Debugging Start: Script Loaded ---');
        document.getElementById('jsError').style.display = 'none'; // 隐藏 JS 错误提示

        let allData = {};
        let sortedIdNumbersArray = [];

        // 预先生成历史页面基础 URL，以便 JavaScript 拼接 ID
        const historyBaseUrl = "{{ url_for('history', id_number_param='') }}";

        // 定义表格的列和对应的键，仅包含核心的定位信息
        const TABLE_COLUMNS = [
            { header: '定位时间', key: '定位时间', class: 'col-locate-time' },
            { header: '纬度', key: '纬度', class: 'col-coords' },
            { header: '经度', key: '经度', class: 'col-coords' },
            { header: '高程', key: '高程', class: 'col-altitude' },
            { header: '自定义数据', key: '自定义数据', class: 'col-custom-data' }
        ];

        try {
            // 使用 Jinja2 的 tojson 过滤器直接将 Python 对象转换为 JS 对象字面量
            allData = {{ all_messages_grouped_js_obj | tojson }};
            sortedIdNumbersArray = {{ sorted_id_numbers_js_arr | tojson }};

            console.log('Received allData (JavaScript object from Flask): ', allData);
            console.log('Number of IDs in allData (after direct assignment): ', Object.keys(allData).length);
            console.log('Received sortedIdNumbersArray:', sortedIdNumbersArray);

            if (Object.keys(allData).length > 0) {
                document.getElementById('initialNoData').style.display = 'none';
            }

        } catch (e) {
            console.error('Error receiving or assigning data from Flask:', e);
            document.getElementById('jsError').style.display = 'block'; // 显示 JS 错误提示
            allData = {};
            sortedIdNumbersArray = [];
        }
        
        const messagesContainer = document.getElementById('messagesContainer');
        const searchQueryInput = document.getElementById('searchQuery');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const noSearchResultsDiv = document.getElementById('noSearchResults');
        const initialNoDataDiv = document.getElementById('initialNoData');
        const displayedIdCountSpan = document.getElementById('displayedIdCount');
        const displayedMessageCountSpan = document.getElementById('displayedMessageCount');

        function createMessageCardHtml(idNumber, msg, totalCount, isHistoryView, highlightQuery) {
            let cardHtml = '';
            const isLatestMessage = !isHistoryView; // 主页模式下，msg就是latest_message

            // 卡片标题：始终显示 ID, 接收时间, 消息ID
            const headerText = `ID: <span class="card-title-text">${highlightText(idNumber, highlightQuery)}</span> - ` + 
                               `接收时间: <span class="card-title-text">${highlightText(msg['接收时间'], highlightQuery)}</span> - ` +
                               `消息ID: <span class="card-title-text">${highlightText(msg['MessageId'], highlightQuery)}</span>`;
            
            const countText = totalCount > 0 ? ` (共 ${totalCount} 条)` : '';
            
            const historyFullLink = `${historyBaseUrl}${encodeURIComponent(idNumber)}`;
            const historyLinkHtml = `<a href="${historyFullLink}" class="button secondary" style="margin-left: 10px;">查看历史</a>`;

            // 获取解析状态文本和类
            const parseStatusText = msg['解析状态'] ? msg['解析状态'].text : 'N/A';
            const parseStatusClass = msg['解析状态'] ? msg['解析状态'].class : '';
            
            // 获取数据标识
            const dataId = msg['数据标识'] || 'N/A';

            cardHtml += `
                <div class="card id-card-yellow" data-id="${idNumber}">
                    <div class="card-header">
                        <div>${headerText}${countText}</div>
                        <div>
                            ${isLatestMessage ? historyLinkHtml : ''}
                            <span class="card-toggle-icon">▶</span>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="message-meta">
                            <div class="item">数据标识: <span>${highlightText(dataId, highlightQuery)}</span></div>
                            <div class="item">解析状态: <span class="${parseStatusClass}">${highlightText(parseStatusText, highlightQuery)}</span></div>
                        </div>
                        <table>
                            <thead>
                                <tr>
            `;
            // 表头
            TABLE_COLUMNS.forEach(col => {
                cardHtml += `<th class="${col.class}">${escapeHtml(col.header)}</th>`;
            });

            cardHtml += `
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
            `;
            // 数据行
            TABLE_COLUMNS.forEach(col => {
                let displayedValue;
                let valueClass = col.class; // 单元格基础类名
                let rawValue = msg[col.key];

                if (col.key === '自定义数据' && String(rawValue).length > 50) { 
                    const shortValue = String(rawValue).substring(0, 50) + '...';
                    displayedValue = `
                        <details style="display: block;">
                            <summary>${highlightText(shortValue, highlightQuery)}</summary>
                            <pre class="code-block" style="max-height: 100px;">${highlightText(String(rawValue), highlightQuery)}</pre>
                        </details>
                    `;
                } else {
                    displayedValue = highlightText(String(rawValue || 'N/A'), highlightQuery);
                }
                
                cardHtml += `<td class="${valueClass}">${displayedValue}</td>`;
            });
            
            cardHtml += `
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return cardHtml;
        }

        function renderMessages() {
            console.log('--- renderMessages called ---');
            const query = searchQueryInput.value.trim().toLowerCase();
            const startDateStr = startDateInput.value;
            const endDateStr = endDateInput.value;
            
            let filteredGroups = [];
            let totalFilteredMessages = 0;
            let displayedIdNumbers = new Set(); 

            if (Object.keys(allData).length === 0) {
                messagesContainer.innerHTML = '';
                displayedIdCountSpan.textContent = 0;
                displayedMessageCountSpan.textContent = 0;
                if (!query && !startDateStr && !endDateStr) {
                    initialNoDataDiv.style.display = 'block';
                    noSearchResultsDiv.style.display = 'none';
                    console.log('allData is empty and no search query, showing initialNoData message.');
                } else {
                    initialNoDataDiv.style.display = 'none';
                    noSearchResultsDiv.style.display = 'block';
                    console.log('allData is empty but search query present, showing noSearchResults message.');
                }
                return;
            } else {
                initialNoDataDiv.style.display = 'none';
            }

            for (const idNumber of sortedIdNumbersArray) { 
                const group = allData[idNumber];
                if (!group || !group.latest_message) continue;

                const latestMsg = group.latest_message;

                // 日期范围过滤
                let passDateFilter = true;
                if (startDateStr || endDateStr) {
                    const receiveTime = latestMsg['接收时间'];
                    if (receiveTime) {
                        try {
                            const messageDate = new Date(receiveTime.split('T')[0]); 
                            if (isNaN(messageDate.getTime())) {
                                console.warn(`Invalid date format for receiveTime: ${receiveTime}`);
                                passDateFilter = false;
                            } else {
                                const start = startDateStr ? new Date(startDateStr) : null;
                                const end = endDateStr ? new Date(endDateStr) : null;
                                
                                if (start && messageDate < start) {
                                    passDateFilter = false;
                                }
                                if (end && messageDate > end) {
                                    passDateFilter = false;
                                }
                            }
                        } catch (e) {
                            console.error("日期解析错误:", e, "Receive Time:", receiveTime);
                            passDateFilter = false;
                        }
                    } else {
                        passDateFilter = false;
                    }
                }

                if (!passDateFilter) continue;

                // 模糊搜索过滤
                let passQueryFilter = false;
                if (!query) {
                    passQueryFilter = true;
                } else {
                    if (String(idNumber).toLowerCase().includes(query)) {
                        passQueryFilter = true;
                    } else {
                        for (const key in latestMsg) {
                            if (latestMsg.hasOwnProperty(key)) {
                                let valueToSearch;
                                if (key === '解析状态' && typeof latestMsg[key] === 'object' && latestMsg[key] !== null && 'text' in latestMsg[key]) {
                                    valueToSearch = latestMsg[key].text;
                                } else {
                                    valueToSearch = String(latestMsg[key]);
                                }

                                if (valueToSearch.toLowerCase().includes(query)) {
                                    passQueryFilter = true;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                if (passQueryFilter) {
                    filteredGroups.push({ id: idNumber, data: group });
                    displayedIdNumbers.add(idNumber);
                    totalFilteredMessages += group.total_count;
                }
            }

            messagesContainer.innerHTML = '';
            if (filteredGroups.length === 0) {
                noSearchResultsDiv.style.display = 'block';
            } else {
                noSearchResultsDiv.style.display = 'none';
                
                filteredGroups.forEach(group => {
                    const cardHtml = createMessageCardHtml(group.id, group.data.latest_message, group.data.total_count, false, query);
                    messagesContainer.innerHTML += cardHtml;
                });

                bindCardToggleEvents();
            }

            displayedIdCountSpan.textContent = displayedIdNumbers.size;
            displayedMessageCountSpan.textContent = totalFilteredMessages;
            console.log('--- renderMessages finished ---');
            console.log(`Displayed IDs: ${displayedIdNumbers.size}, Total Messages: ${totalFilteredMessages}`);
        }

        searchQueryInput.addEventListener('input', renderMessages);
        startDateInput.addEventListener('change', renderMessages);
        endDateInput.addEventListener('change', renderMessages);

        document.addEventListener('DOMContentLoaded', renderMessages);
        
    </script>
{% endblock %}
