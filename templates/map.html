{% extends "base.html" %}

{% block title %}高德地图定位数据展示{% endblock %}
{% block page_title %}高德地图定位数据展示{% endblock %}

{% block nav_links %}
    <a href="{{ url_for('index') }}">首页</a>
    <a href="{{ url_for('map_page') }}">地图</a>
{% endblock %}

{% block content %}
    <style>
        /* 整体控制面板容器 */
        #map-controls-container {
            display: grid;
            grid-template-columns: 1fr; /* 默认单列 */
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 单个控制卡片样式 */
        .control-card {
            background-color: #fcfcfc;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* 响应式布局：中等屏幕以上两列 */
        @media (min-width: 992px) {
            #map-controls-container {
                grid-template-columns: 2fr 1fr; /* 左侧常规查询宽，右侧实时更新窄 */
            }
        }
        @media (max-width: 991px) {
            #map-controls-container {
                grid-template-columns: 1fr; /* 小屏幕下改为单列 */
            }
            .control-card:first-child { /* 常规查询卡片在小屏幕上可能需要调整布局 */
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                align-items: flex-end;
            }
            .control-card:first-child .button-wrapper {
                grid-column: span 1;
                justify-content: flex-start;
            }
        }
        
        /* 针对常规查询卡片内部布局 */
        #static-query-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* 响应式布局 */
            gap: 20px;
            align-items: flex-end;
        }

        #static-query-card label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--heading-color);
            font-size: 0.95em;
        }
        #static-query-card select,
        #static-query-card input[type="text"],
        #static-query-card input[type="datetime-local"],
        #static-query-card input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        #static-query-card select:focus,
        #static-query-card input[type="text"]:focus,
        #static-query-card input[type="datetime-local"]:focus,
        #static-query-card input[type="number"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        /* 禁用时的样式 */
        #static-query-card select:disabled,
        #static-query-card input[type="text"]:disabled,
        #static-query-card input[type="datetime-local"]:disabled,
        #static-query-card input[type="number"]:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        /* ID选择器选中项的样式 */
        #idSelector option:checked {
            background-color: #e0f2f7; /* 淡蓝色，更美观 */
            color: #333;
            font-weight: 600;
        }

        #static-query-card .input-group {
            display: flex;
            gap: 10px;
        }
        #static-query-card .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            align-items: center;
        }
        #static-query-card .radio-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
        }
        #static-query-card .radio-group input[type="radio"] {
            margin-right: 5px;
            width: auto;
        }
        /* 禁用Radio按钮的文本颜色 */
        #static-query-card .radio-group input[type="radio"]:disabled + label {
            color: #999;
            cursor: not-allowed;
        }

        #static-query-card .button-wrapper {
            grid-column: span 1; /* 占据一列 */
            display: flex;
            justify-content: flex-end; /* 按钮靠右对齐 */
            align-items: flex-end; /* 底部对齐 */
        }
        #static-query-card .button {
            width: auto; /* 按钮宽度自适应 */
        }
        #id-selector-group { /* 用于包装ID选择器和全选按钮 */
            display: flex;
            flex-direction: column;
            gap: 10px; /* 间距 */
        }
        #select-all-ids-button {
            display: inline-block;
            padding: 8px 15px;
            background-color: var(--secondary-color);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-size: 0.9em;
            font-weight: 500;
            border: none;
            cursor: pointer;
            align-self: flex-start; /* 按钮靠左 */
        }
        #select-all-ids-button:hover {
            background-color: var(--secondary-hover-color);
            transform: translateY(-1px);
        }
        #select-all-ids-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* ====== 实时更新控制卡片样式 ====== */
        #realtime-update-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #realtime-update-card h3 {
            margin-top: 0;
            color: var(--heading-color);
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        /* 实时更新的复选框组已移除 */

        .realtime-update-interval-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .realtime-update-interval-group label {
            font-weight: 500;
            color: var(--heading-color);
            margin-bottom: 0;
        }
        .realtime-update-interval-group input[type="number"] {
            width: 80px; /* 控制宽度 */
            text-align: center;
            padding: 8px 10px;
        }
        .realtime-update-info {
            font-size: 0.85em;
            color: #666;
        }
        #realtimeControlButton {
            width: 100%;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-top: 10px;
        }
        #realtimeControlButton:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-1px);
        }
        #realtimeControlButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        /* ================================== */

        /* 消息提示框样式 */
        .map-status-message {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            color: #7f8c8d;
            background-color: #f0f3f5;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px dashed #c0c7cb;
        }
        .map-status-message.success {
            border: 1px dashed var(--success-color);
            color: var(--success-color);
            background-color: #e6f7ed;
        }
        .map-status-message.error {
            border: 1px dashed var(--error-color);
            color: var(--error-color);
            background-color: #fbe6e6;
        }
        .map-status-message.warning {
            border: 1px dashed var(--warning-color);
            color: var(--warning-color);
            background-color: #fff9e6;
        }


        /* 保留原有地图容器样式 */
        #container {
            position: relative; /* 为图例定位提供上下文 */
            width: 100%;
            height: 700px; /* 地图高度 */
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .amap-info-window-content {
            font-family: 'Noto Sans SC', sans-serif, Arial, sans-serif;
            font-size: 0.9em;
            line-height: 1.6;
            color: var(--text-color);
            padding: 5px; /* 确保内容有边距 */
        }
        .amap-info-window-content strong {
            color: var(--heading-color);
        }
        .amap-info-window-content .info-item {
            margin-bottom: 5px;
        }

        /* 针对小屏幕适配 */
        @media (max-width: 576px) {
            #container {
                height: 500px; /* 更小的屏幕更小的高度 */
            }
            #map-legend {
                left: 15px; /* 小屏幕上图例靠左显示，避免遮挡 */
                right: auto;
            }
        }

        /* ================== 自定义Marker和图例样式 ================== */

        /* 自定义蓝色小圆点标记样式（用于历史坐标点） */
        .blue-dot-marker {
            width: 8px; /* 小圆 */
            height: 8px;
            background-color: #007bff; /* 蓝色 */
            border-radius: 50%;
            border: 1px solid #fff;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
            margin: -4px 0 0 -4px; /* 使点居中 */
            box-sizing: border-box;
            cursor: pointer;
        }
        /* 选中蓝色圆点的特殊样式 - 改为红色高亮 */
        .blue-dot-marker.selected {
            border: 2px solid red; /* 选中时边框变红 */
            width: 12px; /* 稍大 */
            height: 12px;
            margin: -6px 0 0 -6px; /* 重新居中 */
            box-shadow: 0 0 5px red; /* 添加红色光晕 */
        }

        /* 自定义图标样式 (高德默认图标是 25x34) */
        .amap-icon img {
            width: 25px;
            height: 34px;
            border: none;
            cursor: pointer;
            /* 为图标添加过渡效果，使高亮更平滑 */
            transition: box-shadow 0.2s ease-in-out; 
        }
        /* 选中红色图钉的特殊样式 - 添加红色光晕 */
        /* 这个类会在JS中动态添加到amap-marker-content元素上 */
        .amap-marker-content.red-pin-selected .amap-icon img {
            box-shadow: 0 0 8px 3px rgba(255, 0, 0, 0.7); /* 红色光晕 */
            /* 可以根据需要调整尺寸 */
            /* width: 28px; height: 38px; */
        }

        /* 地图图例样式 */
        #map-legend {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
            font-size: 0.9em;
            color: var(--text-color);
            transition: all 0.3s ease-in-out; /* 平滑过渡 */
        }
        #map-legend h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--heading-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        #map-legend .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        /* 隐藏图例项的类 */
        .hidden-legend-item {
            display: none !important;
        }

        #map-legend .legend-color-box {
            width: 28px; /* 确保有足够空间显示图标或圆点 */
            height: 28px;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid #ccc; /* 增加边框，更清晰 */
            background-color: #f9f9f9; /* 略微不同的背景色 */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0; /* 防止内容收缩 */
        }
        #map-legend .legend-color-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* 确保图标完整显示 */
            width: 25px; /* 图例中图标尺寸 */
            height: 34px;
            border: none;
        }
        #map-legend .legend-color-box .blue-dot-legend { /* 图例中用不同的类 */
            width: 10px; /* 稍大一点，适应图例盒 */
            height: 10px;
            background-color: #007bff; /* 蓝色 */
            border-radius: 50%;
            border: 1px solid #fff;
            box-shadow: 0 0 1px rgba(0,0,0,0.3);
        }
        #map-legend .legend-color-box .polyline-style-legend {
            height: 4px;
            width: 100%; /* 充满容器宽度 */
            background-color: #888; /* 轨迹线颜色示例 */
            opacity: 0.6;
        }

    </style>

    <div id="map-controls-container">
        {# 常规数据查询卡片 #}
        <div id="static-query-card" class="control-card">
            <div id="id-selector-group">
                <label for="idSelector">选择ID</label>
                <select id="idSelector" multiple size="5"> {# multiple 属性允许多选，size 属性显示更多选项 #}
                    {% for id_num in sorted_id_numbers_js_arr %}
                        <option value="{{ id_num }}">{{ id_num }}</option>
                    {% endfor %}
                </select>
                <button id="select-all-ids-button" type="button">全选ID</button>
            </div>
            
            <div> {# 包含时间范围和显示模式，以便禁用时统一处理 #}
                <div class="time-range-group">
                    <label>时间范围</label>
                    <div class="input-group">
                        <input type="datetime-local" id="mapStartDate">
                        <input type="datetime-local" id="mapEndDate">
                    </div>
                </div>
                <div class="radio-group" style="margin-top: 10px;">
                    <label>
                        <input type="radio" name="displayMode" value="latest" checked> 最新位置
                    </label>
                    <label>
                        <input type="radio" name="displayMode" value="trajectory"> 轨迹
                    </label>
                </div>
            </div>

            <div class="button-wrapper">
                <button id="displayMapData" class="button">显示地图数据</button>
            </div>
        </div>
        
        {# 实时更新控制卡片 #}
        <div id="realtime-update-card" class="control-card">
            <h3>实时更新配置</h3>
            {# 实时更新勾选框已移除 #}
            <div class="realtime-update-interval-group">
                <label for="refreshInterval">刷新间隔 (秒):</label>
                <input type="number" id="refreshInterval" class="form-control" value="10" min="1">
            </div>
            <p class="realtime-update-info" id="realtimeInfoText">实时更新将显示**当前已选择ID**的最新有效位置。</p>
            <button id="realtimeControlButton" class="button primary">停止实时更新</button> {# 默认显示停止按钮 #}
        </div>
    </div>

    {# 两个消息提示区域 #}
    <div id="noMapDataMessage" class="map-status-message" style="display: none;">
        当前筛选条件下没有找到任何有效的定位数据。
    </div>
    <div id="realtimeStatusMessage" class="map-status-message success" style="display: none;">
        实时更新中... (每 <span id="currentRefreshInterval">10</span> 秒刷新一次)
    </div>

    <div id="container">
        <!-- 图例将在这里动态生成 -->
    </div>

    <script type="text/javascript">
        // ！！！重要：请将此处的 securityJsCode 替换为您自己的高德JS API 安全密钥！！！
        window._AMapSecurityConfig = {
            securityJsCode: '{{ amap_jsapi_key }}', // 使用后端传递的密钥
        };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key={{ amap_jsapi_key }}&plugin=AMap.MarkerClusterer"></script>
    <script type="text/javascript">
        console.log('--- Frontend Debugging Start: Script Loaded (map.html) ---');

        const allMessagesGroupedById = {{ all_messages_grouped_by_id | tojson }};
        const sortedIdNumbersArray = {{ sorted_id_numbers_js_arr | tojson }};
        
        // DOM 元素获取
        const idSelector = document.getElementById('idSelector');
        const selectAllIdsButton = document.getElementById('select-all-ids-button');
        const mapStartDateInput = document.getElementById('mapStartDate');
        const mapEndDateInput = document.getElementById('mapEndDate');
        const displayModeRadios = document.querySelectorAll('input[name="displayMode"]');
        const displayModeLatestRadio = document.querySelector('input[name="displayMode"][value="latest"]');
        const displayModeTrajectoryRadio = document.querySelector('input[name="displayMode"][value="trajectory"]');
        const displayMapDataButton = document.getElementById('displayMapData'); // 非实时模式的显示数据按钮
        const mapContainer = document.getElementById('container');
        const noMapDataMessage = document.getElementById('noMapDataMessage');
        const realtimeStatusMessage = document.getElementById('realtimeStatusMessage');
        const currentRefreshIntervalSpan = document.getElementById('currentRefreshInterval');
        
        // 实时更新相关DOM元素和变量
        const refreshIntervalInput = document.getElementById('refreshInterval');
        const realtimeInfoText = document.getElementById('realtimeInfoText');
        const realtimeControlButton = document.getElementById('realtimeControlButton'); // 实时模式的控制按钮

        let realtimeUpdateIntervalId = null; // 用于存储实时更新的定时器ID
        const defaultRealtimeRefreshInterval = 10; // 默认刷新间隔秒数
        let latestRealtimeMarkers = {}; // 存储实时更新模式下地图上显示的最新标记，键是IdNumber

        let map = null;
        let markers = []; // 存储所有地图上的标记 (非实时更新模式下使用)
        let polylines = []; // 存储所有轨迹线 (非实时更新模式下使用)
        let infoWindow = null; // 高德地图信息窗体
        let currentSelectedMarker = null; // 存储当前被选中的标记

        // 自定义图标URL
        const redIconUrl = '//webapi.amap.com/theme/v1.3/markers/n/mark_r.png'; // 红色图钉 (用于最新坐标)
        const blueDotContent = '<div class="blue-dot-marker"></div>'; // 蓝色小圆点 (用于历史坐标)
        
        // 初始化ID选择器
        function initializeIdSelector() {
            idSelector.innerHTML = ''; // 清空现有选项
            if (sortedIdNumbersArray.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '暂无ID数据';
                option.disabled = true;
                idSelector.appendChild(option);
                selectAllIdsButton.disabled = true; // 如果没有ID，禁用全选按钮
            } else {
                sortedIdNumbersArray.forEach(idNum => {
                    const option = document.createElement('option');
                    option.value = idNum;
                    option.textContent = idNum;
                    option.selected = true; // 默认选中所有ID
                    idSelector.appendChild(option);
                });
                selectAllIdsButton.disabled = false; // 有ID时启用全选按钮
            }
        }

        // 解析经纬度字符串为十进制浮点数 (保留原有函数，尽管后端已处理)
        function parseCoordinateToDecimal(dmmStr, hemisphere) {
            if (!dmmStr || !hemisphere || !/^\d+\.\d+$/.test(dmmStr)) {
                return null;
            }
            try {
                const parts = dmmStr.split('.');
                let degreesStr, minutesStr;
                if (dmmStr.length === 10) { // ddmm.mmmmm
                    degreesStr = parts[0].substring(0, 2);
                    minutesStr = parts[0].substring(2) + '.' + parts[1];
                } else if (dmmStr.length === 11) { // dddmm.mmmmm
                    degreesStr = parts[0].substring(0, 3);
                    minutesStr = parts[0].substring(3) + '.' + parts[1];
                } else {
                    return null; // 格式不匹配
                }

                const degrees = parseFloat(degreesStr);
                const minutes = parseFloat(minutesStr);
                let decimalDeg = degrees + minutes / 60;

                if (['S', 'W'].includes(hemisphere.toUpperCase())) {
                    decimalDeg = -decimalDeg;
                }
                return parseFloat(decimalDeg.toFixed(6)); // 保留6位小数
            } catch (e) {
                console.error("Error parsing coordinate:", dmmStr, hemisphere, e);
                return null;
            }
        }

        // 生成随机颜色 (保留原有函数)
        function getRandomColor(id) {
            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        // 辅助函数：判断消息是否匹配日期时间范围 (保留原有函数)
        function messageMatchesDateRange(msg, startDateStr, endDateStr) {
            if (!startDateStr && !endDateStr) return true;

            const receiveTime = msg['接收时间'];
            if (!receiveTime) return false;

            try {
                const messageDate = new Date(receiveTime);
                if (isNaN(messageDate.getTime())) {
                    return false;
                }

                let start = startDateStr ? new Date(startDateStr) : null;
                let end = endDateStr ? new Date(endDateStr) : null;
                
                if (start && isNaN(start.getTime())) { start = null; }
                if (end && isNaN(end.getTime())) { end = null; }

                if (start && messageDate < start) {
                    return false;
                }
                if (end && messageDate > end) {
                    return false;
                }
                return true;
            } catch (e) {
                console.error("日期时间解析错误:", e, "Receive Time:", receiveTime);
                return false;
            }
        }

        // 清空所有地图覆盖物（非实时更新模式）
        function clearAllStaticMapElements() {
            if (map) {
                map.remove(markers);
                map.remove(polylines);
                markers = [];
                polylines = [];
                if (infoWindow && infoWindow.getIsOpen()) infoWindow.close();
                if (currentSelectedMarker) {
                    resetMarkerState(currentSelectedMarker);
                    currentSelectedMarker = null;
                }
                console.log('Cleared all non-realtime map elements.');
            }
        }

        // 清空实时更新模式下的标记
        function clearRealtimeMarkers() {
            if (map) {
                const markersToRemove = Object.values(latestRealtimeMarkers);
                map.remove(markersToRemove);
                latestRealtimeMarkers = {};
                if (infoWindow && infoWindow.getIsOpen()) infoWindow.close();
                if (currentSelectedMarker) { // 清除旧的选中标记状态
                    resetMarkerState(currentSelectedMarker);
                    currentSelectedMarker = null;
                }
                console.log('Cleared all realtime markers.');
            }
        }

        // 核心函数：绘制地图数据（非实时更新模式下调用）
        function renderMapData() {
            console.log('--- renderMapData called (map.html) ---');
            // 如果实时更新正在运行，阻止非实时模式的渲染
            if (realtimeUpdateIntervalId) {
                console.warn("Real-time update is active, cannot render static map data. Please stop real-time update first.");
                noMapDataMessage.textContent = '实时更新正在运行中，无法显示历史数据。请先停止实时更新。';
                noMapDataMessage.className = 'map-status-message warning';
                noMapDataMessage.style.display = 'block';
                return;
            }

            // 清除旧的覆盖物和高亮状态
            clearAllStaticMapElements();
            realtimeStatusMessage.style.display = 'none'; // 隐藏实时更新状态信息

            const selectedIds = Array.from(idSelector.selectedOptions).map(option => option.value);
            const startDateStr = mapStartDateInput.value;
            const endDateStr = mapEndDateInput.value;
            const displayMode = document.querySelector('input[name="displayMode"]:checked').value;

            if (selectedIds.length === 0) {
                noMapDataMessage.textContent = '请选择至少一个ID来显示地图数据。';
                noMapDataMessage.className = 'map-status-message warning';
                noMapDataMessage.style.display = 'block';
                handleDisplayModeChange(); 
                return;
            } else {
                noMapDataMessage.style.display = 'none';
            }

            let allPointsForFitView = []; // 用于地图视野调整的所有有效经纬度点

            selectedIds.forEach(idNumber => {
                const messagesForId = allMessagesGroupedById[idNumber];
                if (!messagesForId || messagesForId.length === 0) return;

                let validLocationsForId = [];

                // 筛选出有有效经纬度的消息，并解析为十进制
                messagesForId.forEach(msg => {
                    const lat = msg['decimal_latitude'];
                    const lon = msg['decimal_longitude'];
                    
                    if (lat !== null && lon !== null && typeof lat === 'number' && typeof lon === 'number' &&
                        messageMatchesDateRange(msg, startDateStr, endDateStr)) {
                        validLocationsForId.push({
                            lnglat: [lon, lat], // 高德地图使用 [longitude, latitude]
                            message: msg,
                            receiveTime: msg['接收时间']
                        });
                    }
                });

                // 按接收时间降序排序，确保最新点在第一个
                validLocationsForId.sort((a, b) => new Date(b.receiveTime) - new Date(a.receiveTime));


                if (validLocationsForId.length === 0) {
                    console.warn(`ID ${idNumber} 在指定条件下没有有效的定位数据。`);
                    return;
                }

                // 根据显示模式绘制
                if (displayMode === 'latest') {
                    const latestLocation = validLocationsForId[0];
                    if (latestLocation) {
                        // 最新位置模式下只显示最新坐标（红色图钉）
                        const marker = createCustomMarker(latestLocation.lnglat, latestLocation.message, 'latest');
                        markers.push(marker);
                        allPointsForFitView.push(new AMap.LngLat(latestLocation.lnglat[0], latestLocation.lnglat[1]));
                    }
                } else if (displayMode === 'trajectory') {
                    // 确保轨迹模式下至少有两个点才能绘制线
                    if (validLocationsForId.length > 1) {
                        const path = validLocationsForId.map(loc => loc.lnglat);
                        const trajectoryColor = getRandomColor(idNumber);

                        const polyline = new AMap.Polyline({
                            path: path,
                            strokeColor: trajectoryColor,
                            strokeOpacity: 0.6, // 半透明
                            strokeWeight: 4,
                            strokeStyle: 'solid', // 实线
                            map: map
                        });
                        polylines.push(polyline);
                        // 将所有轨迹点转换为 AMap.LngLat 对象并加入视野调整
                        allPointsForFitView.push(...path.map(p => new AMap.LngLat(p[0], p[1])));
                    }


                    // 轨迹上的每个点也作为一个Marker
                    validLocationsForId.forEach((loc, index) => {
                        let type;
                        if (index === 0) { // 排序后，第一个点是最新点
                            // 轨迹的第一个点（最新点）视为最新坐标 (红色图钉)
                            type = 'latest'; 
                        } else { 
                            // 其他所有点视为历史坐标 (蓝色小圆点)
                            type = 'history'; 
                        }
                        const marker = createCustomMarker(loc.lnglat, loc.message, type);
                        markers.push(marker);
                    });
                }
            });

            // 调整地图视野以适应所有点
            if (allPointsForFitView.length > 0) {
                const bounds = new AMap.Bounds();
                allPointsForFitView.forEach(point => {
                    // 确保point是AMap.LngLat对象，或者转换为它
                    if (point instanceof AMap.LngLat) {
                        bounds.extend(point);
                    } else if (Array.isArray(point) && point.length === 2) { // 兼容 [lng, lat] 数组
                        bounds.extend(new AMap.LngLat(point[0], point[1]));
                    }
                });
                map.setFitView(null, false, [50, 50, 50, 50]); // 增加一些边距
                console.log(`Map FitView adjusted to cover ${allPointsForFitView.length} points.`);
            } else {
                noMapDataMessage.textContent = '当前筛选条件下没有找到任何有效的定位数据。';
                noMapDataMessage.className = 'map-status-message warning';
                noMapDataMessage.style.display = 'block';
            }

            // 更新图例显示状态
            handleDisplayModeChange();
        }

        /**
         * 创建自定义Marker
         * @param {Array} lnglat - [longitude, latitude]
         * @param {Object} message - 原始消息数据
         * @param {string} type - 'latest', 'history'
         */
        function createCustomMarker(lnglat, message, type) {
            let markerOptions = {
                position: lnglat,
                map: map,
                extData: { message: message, type: type } // 存储原始消息和类型
            };

            if (type === 'history') {
                // 历史坐标用蓝色小圆点
                markerOptions.content = blueDotContent;
                markerOptions.offset = new AMap.Pixel(-4, -4); // 确保小圆点中心对齐
            } else { // type === 'latest'
                // 最新坐标用红色图钉
                markerOptions.icon = new AMap.Icon({
                    image: redIconUrl,
                    size: new AMap.Size(25, 34),
                    imageOffset: new AMap.Pixel(0, 0)
                });
                markerOptions.offset = new AMap.Pixel(-12, -34); // 确保图标底部中心对齐
            }

            const marker = new AMap.Marker(markerOptions);

            // 在Marker添加到地图后，存储其DOM引用
            // 这是为了能够直接操作其DOM元素以实现高亮效果
            marker.on('added', function() {
                // marker.dom 是 Marker 的根 DOM 元素
                // 对于 icon 类型的 Marker，amap-marker-content 是它的子元素，包含 icon img
                // 对于 content 类型的 Marker (蓝色小圆点), marker.dom 就是它的内容div
                if (type === 'latest') {
                    // 对于红色图钉，我们需要其包含图标的父级元素
                    const markerContent = this.dom.querySelector('.amap-marker-content');
                    if (markerContent) {
                        this.getExtData().markerDOM = markerContent;
                    } else {
                        console.warn("Could not find .amap-marker-content for latest marker.", this);
                        this.getExtData().markerDOM = this.dom; // fallback
                    }
                } else { // 'history'
                    this.getExtData().markerDOM = this.dom; // 蓝色小圆点，它的内容就是其根dom
                }
            });

            // 绑定点击事件
            marker.on('click', (e) => handleMarkerClick(e.target));

            return marker;
        }

        /**
         * 处理标记点击事件
         * @param {AMap.Marker} marker - 被点击的Marker实例
         */
        function handleMarkerClick(marker) {
            const extData = marker.getExtData();
            // 健壮性检查
            if (!extData || !extData.message) {
                console.error("Marker's extended data or message is missing.", marker);
                return;
            }
            const message = extData.message;
            const markerType = extData.type;

            // 如果点击的是当前已选中的标记，则关闭信息窗体并清除高亮
            if (currentSelectedMarker === marker) {
                if (infoWindow && infoWindow.getIsOpen()) infoWindow.close();
                resetMarkerState(currentSelectedMarker); // 恢复上一个选中标记的状态
                currentSelectedMarker = null;
                return;
            }

            // 清除上一个选中标记的高亮
            if (currentSelectedMarker) {
                resetMarkerState(currentSelectedMarker);
            }

            // 设置新选中的标记为高亮状态
            currentSelectedMarker = marker;
            highlightMarker(marker, markerType);

            // 显示详细信息
            showInfoWindow(marker.getPosition(), message);
        }

        /**
         * 处理地图点击事件，用于关闭信息窗体和清除选中状态
         * @param {Object} e - 地图点击事件对象
         */
        function handleMapClick(e) {
            // 判断点击是否发生在Marker或信息窗口内部
            const clickedTarget = e.originalEvent.target;
            const isClickOnMarker = clickedTarget.closest('.amap-marker') !== null;
            const isClickOnInfoWindow = clickedTarget.closest('.amap-info-window') !== null;

            if (isClickOnMarker || isClickOnInfoWindow) {
                // 如果是，则不关闭
                return;
            }

            // 如果点击的是地图空白处，关闭信息窗体并清除选中状态
            if (infoWindow && infoWindow.getIsOpen()) {
                infoWindow.close();
            }
            if (currentSelectedMarker) {
                resetMarkerState(currentSelectedMarker);
                currentSelectedMarker = null;
            }
            // console.log('Map clicked, cleared selection.'); // 调试用
        }


        /**
         * 高亮显示Marker
         * @param {AMap.Marker} marker
         * @param {string} type - 'latest', 'history'
         */
        function highlightMarker(marker, type) {
            const markerDOM = marker.getExtData().markerDOM;
            if (!markerDOM) {
                console.warn("Marker DOM not found for highlighing.", marker);
                return;
            }

            if (type === 'history') {
                // 蓝色小圆点添加选中样式
                markerDOM.classList.add('selected');
            } else { // 'latest'
                // 红色图钉通过操作其DOM元素来添加高亮类
                markerDOM.classList.add('red-pin-selected');
            }
        }

        /**
         * 恢复Marker到非选中状态
         * @param {AMap.Marker} marker
         */
        function resetMarkerState(marker) {
            const extData = marker.getExtData();
            const type = extData ? extData.type : null;
            const markerDOM = marker.getExtData().markerDOM;

            if (!markerDOM) {
                console.warn("Marker DOM not found for resetting.", marker);
                return;
            }

            if (type === 'history') {
                // 移除蓝色小圆点选中样式
                markerDOM.classList.remove('selected');
            } else { // 'latest'
                // 移除红色图钉的高亮类
                markerDOM.classList.remove('red-pin-selected');
            }
        }

        // 显示信息窗体 (修复：确保数据完整性，并统一处理)
        function showInfoWindow(lnglat, msg) {
            // 确保 lnglat 是有效的 AMap.LngLat 对象
            if (!(lnglat instanceof AMap.LngLat)) {
                console.error("showInfoWindow received invalid LngLat object:", lnglat);
                return;
            }
            
            // 优化显示信息，优先显示有效数据，否则显示 'N/A'
            const messageId = msg['MessageId'] || 'N/A';
            const locateTime = msg['定位时间'] || 'N/A';
            const receiveTime = msg['接收时间'] || 'N/A';
            
            // 增强纬度/经度显示：同时显示原始值和解析后的十进制值
            const rawLatitude = msg['纬度'] || 'N/A';
            const decimalLatitude = (msg['decimal_latitude'] !== null && typeof msg['decimal_latitude'] === 'number') ? msg['decimal_latitude'].toFixed(6) : 'N/A';
            const formattedLatitude = (rawLatitude !== 'N/A' && decimalLatitude !== 'N/A') ? `${rawLatitude} (${decimalLatitude})` : (rawLatitude !== 'N/A' ? rawLatitude : decimalLatitude);


            const rawLongitude = msg['经度'] || 'N/A';
            const decimalLongitude = (msg['decimal_longitude'] !== null && typeof msg['decimal_longitude'] === 'number') ? msg['decimal_longitude'].toFixed(6) : 'N/A';
            const formattedLongitude = (rawLongitude !== 'N/A' && decimalLongitude !== 'N/A') ? `${rawLongitude} (${decimalLongitude})` : (rawLongitude !== 'N/A' ? rawLongitude : decimalLongitude);


            const altitude = msg['高程'] || 'N/A';
            const customData = msg['自定义数据'] ? (msg['自定义数据'].length > 50 ? msg['自定义数据'].substring(0, 50) + '...' : msg['自定义数据']) : 'N/A';


            let content = `
                <div class="amap-info-window-content">
                    <h4>ID: ${msg['IdNumber'] || 'N/A'} <strong>（已选中）</strong></h4>
                    <div class="info-item"><strong>接收时间:</strong> ${receiveTime}</div>
                    <div class="info-item"><strong>消息ID:</strong> ${messageId}</div>
                    <div class="info-item"><strong>定位时间:</strong> ${locateTime}</div>
                    <div class="info-item"><strong>纬度:</strong> ${formattedLatitude}</div>
                    <div class="info-item"><strong>经度:</strong> ${formattedLongitude}</div>
                    <div class="info-item"><strong>高程:</strong> ${altitude}</div>
                    <div class="info-item"><strong>自定义数据:</strong> ${customData}</div>
                    <p><a href="{{ url_for('history', id_number_param='') }}${encodeURIComponent(msg['IdNumber'] || '')}" target="_blank" class="button secondary" style="padding: 5px 10px; font-size: 0.85em; margin-top: 10px;">查看该ID所有历史消息</a></p>
                </div>
            `;
            infoWindow.setContent(content);
            infoWindow.open(map, lnglat);
            // console.log("Info window opened for:", msg['IdNumber']); // 调试用
        }

        // 创建并添加到地图的图例
        function createMapLegend() {
            const legendDiv = document.createElement('div');
            legendDiv.id = 'map-legend';
            legendDiv.innerHTML = `
                <h4>地图图例</h4>
                <div class="legend-item" id="legend-latest-coordinate">
                    <div class="legend-color-box"><img src="${redIconUrl}" alt="最新坐标"></div>
                    <span>最新坐标</span>
                </div>
                <div class="legend-item" id="legend-history-coordinate">
                    <div class="legend-color-box"><div class="blue-dot-legend"></div></div>
                    <span>历史坐标</span>
                </div>
                <div class="legend-item" id="legend-trajectory-line">
                    <div class="legend-color-box"><div class="polyline-style-legend"></div></div>
                    <span>轨迹线 (颜色随ID变化)</span>
                </div>
            `;
            mapContainer.appendChild(legendDiv);
            console.log('Map legend created.');
        }

        // 处理显示模式切换时的图例显示逻辑
        function handleDisplayModeChange() {
            const legendLatestCoordinate = document.getElementById('legend-latest-coordinate');
            const legendHistoryCoordinate = document.getElementById('legend-history-coordinate');
            const legendLine = document.getElementById('legend-trajectory-line');

            // 实时更新模式下，只显示最新坐标的图例
            if (realtimeUpdateIntervalId) { // 判断是否处于实时更新状态
                if (legendLatestCoordinate) legendLatestCoordinate.classList.remove('hidden-legend-item');
                if (legendHistoryCoordinate) legendHistoryCoordinate.classList.add('hidden-legend-item');
                if (legendLine) legendLine.classList.add('hidden-legend-item');
                console.log('Legend display updated for Real-time mode.');
                return;
            }

            // 非实时更新模式下，根据radio按钮状态显示图例
            const displayMode = document.querySelector('input[name="displayMode"]:checked').value;

            if (legendLatestCoordinate) legendLatestCoordinate.classList.remove('hidden-legend-item'); // 最新坐标在两种模式下都可能出现，默认显示

            if (displayMode === 'latest') {
                // 最新位置模式下，隐藏历史坐标和轨迹线
                if (legendHistoryCoordinate) legendHistoryCoordinate.classList.add('hidden-legend-item');
                if (legendLine) legendLine.classList.add('hidden-legend-item');
            } else if (displayMode === 'trajectory') {
                // 轨迹模式下，显示历史坐标和轨迹线
                if (legendHistoryCoordinate) legendHistoryCoordinate.classList.remove('hidden-legend-item');
                if (legendLine) legendLine.classList.remove('hidden-legend-item');
            }
            console.log(`Legend display updated for mode: ${displayMode}`);
        }

        // ===============================================
        // ====== 实时更新功能相关函数 ======
        // ===============================================

        async function updateLatestLocationsOnMap() {
            const selectedIds = Array.from(idSelector.selectedOptions).map(option => option.value);

            // 清除上次的警告或成功消息，等待本次更新结果
            noMapDataMessage.style.display = 'none';
            realtimeStatusMessage.className = 'map-status-message success'; // 假设成功
            realtimeStatusMessage.style.display = 'block';


            if (selectedIds.length === 0) {
                noMapDataMessage.textContent = '实时更新：请至少选择一个ID。';
                noMapDataMessage.className = 'map-status-message warning';
                noMapDataMessage.style.display = 'block';
                realtimeStatusMessage.style.display = 'none';
                clearRealtimeMarkers(); // 确保清空地图
                return;
            }

            console.log("Fetching latest locations for selected IDs:", selectedIds.join(','));
            try {
                // ！！！重要！！！ 后端 /api/latest_locations 接口的预期行为：
                // 1. 接收 `id_numbers` 参数，只返回这些 ID 的数据。
                // 2. 对于每个 ID，按接收时间倒序查找，返回【第一个】`decimal_latitude` 和 `decimal_longitude` 都【不为 null】的消息。
                // 3. 如果某个 ID 的所有消息都没有有效定位数据，则后端应在响应中【不包含】该 ID 的数据。
                //    或者，如果包含，则其 `decimal_latitude` 和 `decimal_longitude` 必须为 `null`。
                const response = await fetch(`/api/latest_locations?id_numbers=${selectedIds.join(',')}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const rawLatestData = await response.json(); // 获取原始数据
                console.log("Received raw latest data:", rawLatestData);

                // 筛选并验证数据：确保只处理当前选中的ID，且经纬度有效
                // 前端再次过滤，以防后端未能完全按照预期过滤或返回不完整数据。
                const validLatestData = rawLatestData.filter(data => 
                    selectedIds.includes(data.IdNumber) &&
                    data.decimal_latitude !== null && typeof data.decimal_latitude === 'number' &&
                    data.decimal_longitude !== null && typeof data.decimal_longitude === 'number'
                );
                console.log("Filtered and validated latest data for map display:", validLatestData);

                // 清除所有当前实时标记，以避免重复和保持最新状态
                if (currentSelectedMarker && Object.values(latestRealtimeMarkers).includes(currentSelectedMarker)) {
                    resetMarkerState(currentSelectedMarker);
                    currentSelectedMarker = null;
                }
                map.remove(Object.values(latestRealtimeMarkers));
                latestRealtimeMarkers = {}; // 重置

                let allPointsForFitView = []; // 存储所有有效的 AMap.LngLat 对象

                if (validLatestData.length === 0) {
                    // 如果所有选中的ID都没有返回有效数据
                    noMapDataMessage.textContent = '实时更新：所选ID暂无有效的定位数据。';
                    noMapDataMessage.className = 'map-status-message warning';
                    noMapDataMessage.style.display = 'block';
                    realtimeStatusMessage.style.display = 'none'; // 隐藏实时更新状态
                } else {
                    noMapDataMessage.style.display = 'none';
                    realtimeStatusMessage.style.display = 'block'; // 显示实时更新状态
                }

                validLatestData.forEach(data => {
                    const idNum = data.IdNumber;
                    const lat = data.decimal_latitude;
                    const lng = data.decimal_longitude;

                    // 再次确认经纬度有效性，以防万一
                    if (lat !== null && lng !== null) {
                        const newPosition = new AMap.LngLat(lng, lat);
                        
                        const marker = createCustomMarker([lng, lat], data, 'latest'); // createCustomMarker 接受 [lng, lat] 数组
                        latestRealtimeMarkers[idNum] = marker; // 存储新标记
                        map.add(marker); // 添加到地图
                        allPointsForFitView.push(newPosition); // 加入视野调整，这里使用 AMap.LngLat 对象
                    }
                });
                
                // 根据选择的ID数量调整地图视野
                if (allPointsForFitView.length > 0) {
                    // 检查是否只有一个ID被选中，且数据中只有一个有效点
                    // 理论上实时更新模式下，一个ID只会返回一个最新成功解析的点。
                    // 此时 `selectedIds.length` 和 `allPointsForFitView.length` 都应该为 1。
                    if (allPointsForFitView.length === 1) { // 即使选择了多个ID，如果只有一个ID返回有效数据，也只聚焦这个点
                        const singlePoint = allPointsForFitView[0]; // 这是一个 AMap.LngLat 对象
                        map.setCenter(singlePoint);
                        map.setZoom(16); // 设定一个合适的放大级别，例如16
                        console.log(`Map centered and zoomed to single point at zoom 16.`);
                    } else {
                        // 否则，自适应视野以显示所有点（多个ID，或单个ID但意外返回多个点）
                        const bounds = new AMap.Bounds();
                        allPointsForFitView.forEach(point => {
                            bounds.extend(point); // allPointsForFitView 存储的是 AMap.LngLat 对象，直接 extend
                        });
                        map.setFitView(null, false, [50, 50, 50, 50]); // 增加一些边距
                        console.log(`Map FitView adjusted to cover ${allPointsForFitView.length} points.`);
                    }
                }

            } catch (error) {
                console.error("Error fetching latest locations:", error);
                noMapDataMessage.textContent = `实时更新失败：${error.message || '网络错误'}`;
                noMapDataMessage.className = 'map-status-message error';
                noMapDataMessage.style.display = 'block';
                realtimeStatusMessage.style.display = 'none';
                stopRealtimeUpdate(); // 停止实时更新
            }
        }

        function startRealtimeUpdate() {
            stopRealtimeUpdate(); // 先清除任何现有定时器

            let interval = parseInt(refreshIntervalInput.value);
            if (isNaN(interval) || interval < 1) {
                interval = defaultRealtimeRefreshInterval;
                refreshIntervalInput.value = defaultRealtimeRefreshInterval;
            }
            currentRefreshIntervalSpan.textContent = interval; // 更新显示的间隔

            console.log(`Starting real-time update with interval: ${interval} seconds`);
            
            clearAllStaticMapElements(); // 清空静态数据
            // clearRealtimeMarkers(); // 确保也清空之前的实时标记 (在 updateLatestLocationsOnMap 内部处理)

            // 禁用常规查询控制项
            setStaticQueryControlsEnabled(false); 
            // 立即执行一次更新
            updateLatestLocationsOnMap(); 
            // 设置定时器
            realtimeUpdateIntervalId = setInterval(updateLatestLocationsOnMap, interval * 1000);

            realtimeStatusMessage.style.display = 'block';
            // noMapDataMessage.style.display = 'none'; // 交给 updateLatestLocationsOnMap 管理
            realtimeControlButton.textContent = '停止实时更新';
            realtimeControlButton.classList.remove('secondary'); 
            realtimeControlButton.classList.add('primary'); // 默认按钮样式
            handleDisplayModeChange(); // 更新图例显示
        }

        function stopRealtimeUpdate() {
            if (realtimeUpdateIntervalId) {
                clearInterval(realtimeUpdateIntervalId);
                realtimeUpdateIntervalId = null;
                console.log("Stopped real-time update.");
                clearRealtimeMarkers(); // 停止实时更新时，清空实时模式下的标记
            }
            setStaticQueryControlsEnabled(true); // 恢复常规查询控制项
            realtimeStatusMessage.style.display = 'none';
            noMapDataMessage.textContent = '实时更新已停止。请选择ID和时间范围，然后点击“显示地图数据”来查看历史数据。';
            noMapDataMessage.className = 'map-status-message'; // 恢复默认样式
            noMapDataMessage.style.display = 'block';
            realtimeControlButton.textContent = '开始实时更新';
            realtimeControlButton.classList.remove('primary');
            realtimeControlButton.classList.add('secondary'); // 可以设置为次要按钮样式
            handleDisplayModeChange(); // 更新图例显示
        }

        /**
         * 启用/禁用常规查询控制项 (ID选择器始终可用)
         * @param {boolean} enable - true为启用，false为禁用
         */
        function setStaticQueryControlsEnabled(enable) {
            // ID选择器和全选按钮始终可用
            // mapStartDateInput.disabled = !enable;
            // mapEndDateInput.disabled = !enable;
            // displayModeRadios.forEach(radio => radio.disabled = !enable);
            // displayMapDataButton.disabled = !enable;

            // 禁用/启用时间范围输入
            mapStartDateInput.disabled = !enable;
            mapEndDateInput.disabled = !enable;

            // 禁用/启用显示模式单选框
            displayModeRadios.forEach(radio => radio.disabled = !enable);
            if (!enable) {
                // 如果禁用，强制选中最新位置，并禁用轨迹选项
                displayModeLatestRadio.checked = true; // 强制选中最新位置
                displayModeTrajectoryRadio.disabled = true; // 禁用轨迹选项
                displayModeTrajectoryRadio.parentNode.style.opacity = '0.5'; // 禁用样式
                displayModeTrajectoryRadio.parentNode.style.cursor = 'not-allowed';
            } else {
                displayModeTrajectoryRadio.disabled = false; // 启用轨迹选项
                displayModeTrajectoryRadio.parentNode.style.opacity = '1'; // 恢复样式
                displayModeTrajectoryRadio.parentNode.style.cursor = 'pointer';
            }
            
            // 禁用/启用显示地图数据按钮
            displayMapDataButton.disabled = !enable; // 非实时模式的按钮，仅在非实时模式下可用
            
            console.log(`Static query controls ${enable ? 'enabled' : 'disabled'}.`);
        }

        // ===============================================
        // ====== 页面初始化逻辑 ======
        // ===============================================
        document.addEventListener('DOMContentLoaded', () => {
            initializeIdSelector();
            createMapLegend(); // 在DOM加载完成后创建图例
            
            // 初始化地图，但不立即加载数据
            map = new AMap.Map('container', {
                zoom: 11,
                center: [116.397428, 39.90923], // 初始中心点：北京
                viewMode: '3D'
            });
            infoWindow = new AMap.InfoWindow({offset: new AMap.Pixel(0, -30)});
            map.on('click', handleMapClick);

            // 设置默认时间为最近24小时 (如果用户停止实时更新后，切换到历史查询会用到)
            const now = new Date();
            const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            mapStartDateInput.value = twentyFourHoursAgo.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
            mapEndDateInput.value = now.toISOString().slice(0, 16);

            // ====== 绑定事件监听器 ======
            // 非实时模式的“显示地图数据”按钮事件
            displayMapDataButton.addEventListener('click', renderMapData);

            // 绑定显示模式切换事件 (非实时模式下)
            displayModeRadios.forEach(radio => {
                radio.addEventListener('change', handleDisplayModeChange);
            });

            // 全选按钮事件
            selectAllIdsButton.addEventListener('click', () => {
                Array.from(idSelector.options).forEach(option => {
                    if (!option.disabled) { // 确保只选择可用的选项
                        option.selected = true;
                    }
                });
                console.log('All IDs selected.');
                // 如果实时更新正在运行，并且用户全选ID，也应该触发一次更新
                if (realtimeUpdateIntervalId) {
                    updateLatestLocationsOnMap();
                }
            });
            
            // 实时控制按钮事件（开始/停止实时更新）
            realtimeControlButton.addEventListener('click', function() {
                if (realtimeUpdateIntervalId) { // 如果正在运行，则停止
                    stopRealtimeUpdate();
                } else { // 如果没有运行，则开始
                    startRealtimeUpdate();
                }
            });

            // 刷新间隔输入框事件
            refreshIntervalInput.addEventListener('change', function() {
                if (realtimeUpdateIntervalId) { // 如果实时更新正在运行，调整间隔后重新启动定时器
                    startRealtimeUpdate(); 
                }
            });
            refreshIntervalInput.value = parseInt(refreshIntervalInput.value) || defaultRealtimeRefreshInterval;
            refreshIntervalInput.min = "1"; // 确保最小值为1秒


            // 页面加载后的默认行为：
            if (sortedIdNumbersArray.length > 0) {
                // 1. initializeIdSelector 已经默认选中所有ID
                // 2. 确保“最新位置”被选中 (在实时模式下，它会自动固定)
                displayModeLatestRadio.checked = true;
                // 3. 默认启动实时更新
                startRealtimeUpdate(); 
                console.log('Default: Starting real-time update for all IDs.');
            } else {
                noMapDataMessage.textContent = '暂无ID数据可显示，请稍后重试。';
                noMapDataMessage.className = 'map-status-message warning';
                noMapDataMessage.style.display = 'block';
                // 即使没有数据，也应该初始化图例状态
                handleDisplayModeChange();
                // 如果没有ID，所有操作都应禁用
                setStaticQueryControlsEnabled(false); 
                selectAllIdsButton.disabled = true;
                refreshIntervalInput.disabled = true;
                realtimeControlButton.disabled = true;
                realtimeControlButton.textContent = '无ID数据';
            }

            // 当ID选择器选择发生变化时，如果实时更新正在运行，重新加载数据
            idSelector.addEventListener('change', () => {
                if (realtimeUpdateIntervalId) {
                    console.log('ID selection changed during real-time update, refreshing map data...');
                    updateLatestLocationsOnMap();
                }
            });
        });

    </script>
{% endblock %}
