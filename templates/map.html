{% extends "base.html" %}

{% block title %}高德地图定位数据展示{% endblock %}
{% block page_title %}高德地图定位数据展示{% endblock %}

{% block nav_links %}
    <a href="{{ url_for('index') }}">首页</a>
    <a href="{{ url_for('map_page') }}">地图</a>
{% endblock %}

{% block content %}
    <style>
        #map-controls {
            background-color: #fcfcfc;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* 响应式布局 */
            gap: 20px;
            align-items: flex-end;
        }
        #map-controls label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--heading-color);
            font-size: 0.95em;
        }
        #map-controls select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #map-controls select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        /* 自定义选中 option 的样式 (如果默认不够明显，可以取消注释) */
        /* #map-controls select option:checked {
            background-color: var(--primary-color);
            color: white;
        } */

        #map-controls .input-group {
            display: flex;
            gap: 10px;
        }
        #map-controls .input-group input {
            flex-grow: 1;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #map-controls .input-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        #map-controls .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            align-items: center;
        }
        #map-controls .radio-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
        }
        #map-controls .radio-group input[type="radio"] {
            margin-right: 5px;
            width: auto;
        }
        #map-controls .button-wrapper {
            grid-column: span 1; /* 占据一列 */
            display: flex;
            justify-content: flex-end; /* 按钮靠右对齐 */
            align-items: flex-end; /* 底部对齐 */
        }
        #map-controls .button {
            width: auto; /* 按钮宽度自适应 */
        }
        #id-selector-group { /* 新增，用于包装ID选择器和全选按钮 */
            display: flex;
            flex-direction: column;
            gap: 10px; /* 间距 */
        }
        #select-all-ids-button {
            display: inline-block;
            padding: 8px 15px;
            background-color: var(--secondary-color);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-size: 0.9em;
            font-weight: 500;
            border: none;
            cursor: pointer;
            align-self: flex-start; /* 按钮靠左 */
        }
        #select-all-ids-button:hover {
            background-color: var(--secondary-hover-color);
            transform: translateY(-1px);
        }

        #container {
            width: 100%;
            height: 700px; /* 地图高度 */
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        .amap-marker-label {
            background-color: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: nowrap;
            border: 1px solid #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transform: translateX(-50%); /* 居中显示 */
            position: relative;
            top: -10px; /* 调整位置避免覆盖marker */
        }
        .amap-info-window-content {
            font-family: 'Noto Sans SC', sans-serif, Arial, sans-serif;
            font-size: 0.9em;
            line-height: 1.6;
            color: var(--text-color);
        }
        .amap-info-window-content strong {
            color: var(--heading-color);
        }
        .amap-info-window-content .info-item {
            margin-bottom: 5px;
        }
        /* 针对小屏幕适配 */
        @media (max-width: 992px) {
            #map-controls {
                grid-template-columns: 1fr; /* 小屏幕下改为单列 */
            }
            #map-controls .button-wrapper {
                justify-content: flex-start; /* 按钮靠左对齐 */
            }
        }
        @media (max-width: 576px) {
            #container {
                height: 500px; /* 更小的屏幕更小的高度 */
            }
        }
    </style>

    <div id="map-controls">
        <div id="id-selector-group">
            <label for="idSelector">选择ID</label>
            <select id="idSelector" multiple size="5"> {# multiple 属性允许多选，size 属性显示更多选项 #}
                {% for id_num in sorted_id_numbers_js_arr %}
                    <option value="{{ id_num }}">{{ id_num }}</option>
                {% endfor %}
            </select>
            <button id="select-all-ids-button" type="button">全选ID</button>
        </div>
        <div>
            <label>时间范围</label>
            <div class="input-group">
                <input type="datetime-local" id="mapStartDate">
                <input type="datetime-local" id="mapEndDate">
            </div>
            <div class="radio-group">
                <label>
                    <input type="radio" name="displayMode" value="latest" checked> 最新位置
                </label>
                <label>
                    <input type="radio" name="displayMode" value="trajectory"> 轨迹
                </label>
            </div>
        </div>
        <div class="button-wrapper">
            <button id="displayMapData" class="button">显示地图数据</button>
        </div>
    </div>

    <div id="noMapDataMessage" class="no-data-message" style="display: block;">
        请选择ID和显示模式，然后点击“显示地图数据”来查看。
    </div>
    <div id="container"></div>

    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: 'a9b2d8c3e4f5g6h7i8j9k0l1m2n3o4p5', // 请替换为你自己的安全密钥
        };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key={{ amap_jsapi_key }}"></script>
    <script type="text/javascript">
        console.log('--- Frontend Debugging Start: Script Loaded (map.html) ---');

        const allMessagesGroupedById = {{ all_messages_grouped_by_id | tojson }};
        const sortedIdNumbersArray = {{ sorted_id_numbers_js_arr | tojson }};
        const idSelector = document.getElementById('idSelector');
        const selectAllIdsButton = document.getElementById('select-all-ids-button'); // 获取全选按钮
        const mapStartDateInput = document.getElementById('mapStartDate');
        const mapEndDateInput = document.getElementById('mapEndDate');
        const displayModeRadios = document.querySelectorAll('input[name="displayMode"]');
        const displayMapDataButton = document.getElementById('displayMapData');
        const mapContainer = document.getElementById('container');
        const noMapDataMessage = document.getElementById('noMapDataMessage');

        let map = null;
        let markers = [];
        let polylines = [];
        let infoWindow = null; // 高德地图信息窗体

        // 初始化ID选择器
        function initializeIdSelector() {
            idSelector.innerHTML = ''; // 清空现有选项
            if (sortedIdNumbersArray.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '暂无ID数据';
                option.disabled = true;
                idSelector.appendChild(option);
                selectAllIdsButton.disabled = true; // 如果没有ID，禁用全选按钮
            } else {
                sortedIdNumbersArray.forEach(idNum => {
                    const option = document.createElement('option');
                    option.value = idNum;
                    option.textContent = idNum;
                    idSelector.appendChild(option);
                });
                selectAllIdsButton.disabled = false; // 有ID时启用全选按钮
            }
        }

        // 解析经纬度字符串为十进制浮点数
        function parseCoordinateToDecimal(dmmStr, hemisphere) {
            if (!dmmStr || !hemisphere || !/^\d+\.\d+$/.test(dmmStr)) {
                return null;
            }
            try {
                const parts = dmmStr.split('.');
                // 假设ddmm.mmmmm 或 dddmm.mmmmm
                // 提取度部分 (前N位) 和分部分 (后两位.五位小数)
                let degreesStr, minutesStr;
                if (dmmStr.length === 10) { // ddmm.mmmmm
                    degreesStr = parts[0].substring(0, 2);
                    minutesStr = parts[0].substring(2) + '.' + parts[1];
                } else if (dmmStr.length === 11) { // dddmm.mmmmm
                    degreesStr = parts[0].substring(0, 3);
                    minutesStr = parts[0].substring(3) + '.' + parts[1];
                } else {
                    return null; // 格式不匹配
                }

                const degrees = parseFloat(degreesStr);
                const minutes = parseFloat(minutesStr);
                let decimalDeg = degrees + minutes / 60;

                if (['S', 'W'].includes(hemisphere.toUpperCase())) {
                    decimalDeg = -decimalDeg;
                }
                return parseFloat(decimalDeg.toFixed(6)); // 保留6位小数
            } catch (e) {
                console.error("Error parsing coordinate:", dmmStr, hemisphere, e);
                return null;
            }
        }

        // 生成随机颜色
        function getRandomColor(id) {
            // 使用ID的hash值确保同一ID颜色一致
            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        // 辅助函数：判断消息是否匹配日期时间范围
        function messageMatchesDateRange(msg, startDateStr, endDateStr) {
            if (!startDateStr && !endDateStr) return true;

            const receiveTime = msg['接收时间'];
            if (!receiveTime) return false;

            try {
                const messageDate = new Date(receiveTime);
                if (isNaN(messageDate.getTime())) {
                    return false;
                }

                const start = startDateStr ? new Date(startDateStr) : null;
                const end = endDateStr ? new Date(endDateStr) : null;
                
                if (start && isNaN(start.getTime())) { start = null; }
                if (end && isNaN(end.getTime())) { end = null; }

                if (start && messageDate < start) {
                    return false;
                }
                if (end && messageDate > end) {
                    return false;
                }
                return true;
            } catch (e) {
                console.error("日期时间解析错误:", e, "Receive Time:", receiveTime);
                return false;
            }
        }

        // 绘制地图数据
        function renderMapData() {
            console.log('--- renderMapData called (map.html) ---');
            if (!map) {
                map = new AMap.Map('container', {
                    zoom: 11,
                    center: [116.397428, 39.90923], // 初始中心点：北京
                    viewMode: '3D'
                });
                infoWindow = new AMap.InfoWindow({offset: new AMap.Pixel(0, -30)});
            }

            // 清除旧的覆盖物
            map.remove(markers);
            map.remove(polylines);
            markers = [];
            polylines = [];
            
            const selectedIds = Array.from(idSelector.selectedOptions).map(option => option.value);
            const startDateStr = mapStartDateInput.value;
            const endDateStr = mapEndDateInput.value;
            const displayMode = document.querySelector('input[name="displayMode"]:checked').value;

            if (selectedIds.length === 0) {
                noMapDataMessage.textContent = '请选择至少一个ID来显示地图数据。';
                noMapDataMessage.style.display = 'block';
                return;
            } else {
                noMapDataMessage.style.display = 'none';
            }

            let allPointsForFitView = []; // 用于地图视野调整的所有有效经纬度点

            selectedIds.forEach(idNumber => {
                const messagesForId = allMessagesGroupedById[idNumber];
                if (!messagesForId || messagesForId.length === 0) return;

                let validLocationsForId = [];

                // 筛选出有有效经纬度的消息，并解析为十进制
                messagesForId.forEach(msg => {
                    // 后端已经解析了 decimal_latitude 和 decimal_longitude
                    const lat = msg['decimal_latitude'];
                    const lon = msg['decimal_longitude'];
                    
                    if (lat !== null && lon !== null && typeof lat === 'number' && typeof lon === 'number' &&
                        messageMatchesDateRange(msg, startDateStr, endDateStr)) {
                        validLocationsForId.push({
                            lnglat: [lon, lat], // 高德地图使用 [longitude, latitude]
                            message: msg,
                            receiveTime: msg['接收时间']
                        });
                    }
                });

                if (validLocationsForId.length === 0) {
                    console.warn(`ID ${idNumber} 在指定条件下没有有效的定位数据。`);
                    return;
                }

                // 根据显示模式绘制
                if (displayMode === 'latest') {
                    // 最新消息在数组的第一个 (因为后端排序了)
                    const latestLocation = validLocationsForId[0];
                    if (latestLocation) {
                        const marker = new AMap.Marker({
                            position: latestLocation.lnglat,
                            map: map,
                            label: {
                                content: idNumber,
                                direction: 'top',
                                offset: new AMap.Pixel(0, -5),
                                style: {
                                    backgroundColor: getRandomColor(idNumber), // 每个ID的marker颜色不同
                                    color: '#fff',
                                    fontSize: '12px',
                                    border: '1px solid #fff',
                                    borderRadius: '4px',
                                    padding: '2px 6px'
                                }
                            }
                        });
                        marker.on('click', () => {
                            showInfoWindow(latestLocation.lnglat, latestLocation.message);
                        });
                        markers.push(marker);
                        allPointsForFitView.push(latestLocation.lnglat);
                    }
                } else if (displayMode === 'trajectory') {
                    // 绘制轨迹和所有点
                    const path = validLocationsForId.map(loc => loc.lnglat);
                    const trajectoryColor = getRandomColor(idNumber);

                    const polyline = new AMap.Polyline({
                        path: path,
                        strokeColor: trajectoryColor,
                        strokeOpacity: 0.8,
                        strokeWeight: 4,
                        strokeStyle: 'dashed', // 虚线
                        strokeDasharray: [10, 5], // 虚线样式
                        map: map
                    });
                    polylines.push(polyline);
                    allPointsForFitView.push(...path); // 将所有轨迹点加入视野调整

                    // 轨迹上的每个点也作为一个Marker，方便点击查看详细信息
                    validLocationsForId.forEach(loc => {
                        const marker = new AMap.Marker({
                            position: loc.lnglat,
                            map: map,
                            icon: new AMap.Icon({
                                image: '//a.amap.com/jsapi_demos/static/demo-center/icons/point.png', // 小点图标
                                size: new AMap.Size(16, 16),
                                imageSize: new AMap.Size(16, 16)
                            })
                        });
                        marker.on('click', () => {
                            showInfoWindow(loc.lnglat, loc.message);
                        });
                        markers.push(marker);
                    });
                }
            });

            // 调整地图视野以适应所有点
            if (allPointsForFitView.length > 0) {
                // setFitView 可以传入 Marker 或 Polyline 数组，或者一个 AMap.Bounds 对象
                // 这里我们传入所有点组成的 Bounds，以确保所有点都在视野内
                const bounds = new AMap.Bounds();
                allPointsForFitView.forEach(point => {
                    bounds.extend(new AMap.LngLat(point[0], point[1]));
                });
                map.setFitView(null, false, [50, 50, 50, 50]); // 增加一些边距，使地图更美观
                console.log(`Map FitView adjusted to cover ${allPointsForFitView.length} points.`);
            } else {
                noMapDataMessage.textContent = '当前筛选条件下没有找到任何有效的定位数据。';
                noMapDataMessage.style.display = 'block';
            }
        }

        // 显示信息窗体
        function showInfoWindow(lnglat, msg) {
            let content = `
                <div>
                    <h4>ID: ${msg['IdNumber']}</h4>
                    <div class="info-item"><strong>接收时间:</strong> ${msg['接收时间']}</div>
                    <div class="info-item"><strong>消息ID:</strong> ${msg['MessageId']}</div>
                    <div class="info-item"><strong>定位时间:</strong> ${msg['定位时间']}</div>
                    <div class="info-item"><strong>纬度:</strong> ${msg['纬度']} (${msg['decimal_latitude'] ? msg['decimal_latitude'].toFixed(6) : 'N/A'})</div>
                    <div class="info-item"><strong>经度:</strong> ${msg['经度']} (${msg['decimal_longitude'] ? msg['decimal_longitude'].toFixed(6) : 'N/A'})</div>
                    <div class="info-item"><strong>高程:</strong> ${msg['高程']}</div>
                    <div class="info-item"><strong>自定义数据:</strong> ${msg['自定义数据'].substring(0, 50)}...</div>
                    <p><a href="{{ url_for('history', id_number_param='') }}${encodeURIComponent(msg['IdNumber'])}" target="_blank" class="button secondary" style="padding: 5px 10px; font-size: 0.85em; margin-top: 10px;">查看该ID所有历史消息</a></p>
                </div>
            `;
            infoWindow.setContent(content);
            infoWindow.open(map, lnglat);
        }

        // 绑定事件
        displayMapDataButton.addEventListener('click', renderMapData);

        // 全选按钮事件
        selectAllIdsButton.addEventListener('click', () => {
            Array.from(idSelector.options).forEach(option => {
                // 确保不选择“暂无ID数据”的禁用选项
                if (!option.disabled) {
                    option.selected = true;
                }
            });
            console.log('All IDs selected.');
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initializeIdSelector();
            // 首次加载页面时，不自动渲染，等待用户点击“显示地图数据”
            // renderMapData(); 
        });

    </script>
{% endblock %}

